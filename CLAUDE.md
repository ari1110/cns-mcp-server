# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## üéØ DEPLOYMENT STRATEGY: Download-and-Go Architecture

**CRITICAL**: This project is designed for **universal deployment** - any user, any environment, zero configuration. All code decisions must support this deployment model.

### Target Users & Installation Methods
1. **Global NPM Install**: `npm install -g cns-mcp-server` (primary method)
2. **Local NPM Install**: `npm install cns-mcp-server` (team/project installs)
3. **Direct Download**: Git clone or zip download (developers)
4. **Package Manager**: Via NPM registry (future)

### Path Resolution Requirements
- **NO hardcoded paths** - All paths must be dynamically resolved
- **Multiple fallback methods** - Support all installation scenarios
- **Environment overrides** - Allow user customization via env vars
- **Graceful error handling** - Clear messages when paths cannot be resolved

### Code Pattern for Path Resolution
```typescript
// ‚úÖ CORRECT - Dynamic resolution with fallbacks
async function findPath(): Promise<string> {
  if (process.env.CUSTOM_PATH) return process.env.CUSTOM_PATH;
  try { return require.resolve('package/path'); } catch {}
  // Try multiple relative path candidates...
}

// ‚ùå WRONG - Hardcoded paths
const path = '/home/user/specific/path';
const path = join(__dirname, '../../hardcoded/structure');
```

This architecture influences:
- CLI client/server path resolution
- Hook script generation  
- Configuration file templates
- Documentation and examples

## Development Commands

### Build and Run
- `npm run build` - Compile TypeScript to JavaScript in dist/
- `npm run dev` - Start development server with file watching
- `npm start` - Run the built server from dist/
- `npm test` - Run tests with Vitest
- `npm run lint` - Run ESLint on src/ directory

### Client
- `npm run build && npx cns-client` - Build and run the CNS client
- The compiled client binary is at `dist/client/index.js`

## Architecture Overview

CNS (Central Nervous System) is an autonomous multi-agent orchestration system designed specifically for Claude Code. The system replaces bash scripts with a centralized TypeScript MCP server that handles agent coordination, memory management, and workspace isolation.

### Core Components

#### MCP Server (`src/index.ts`)
- Main entry point exposing 13+ MCP tools for Claude Code integration
- Handles hook events, memory operations, orchestration, and system status
- Uses stdio transport for Claude Code communication

#### Orchestration Engine (`src/orchestration/engine.ts`)
- Event-driven workflow management with handoffs between agents
- Automatically launches associate agents when managers complete tasks
- Workflow tracking with database persistence and 5-minute cleanup scheduling
- Generates Task tool prompts for autonomous agent execution

#### Memory System (`src/memory/index.ts`)
- **Free semantic search** via Transformers.js (Xenova/all-MiniLM-L6-v2)
- **No API keys required** - 100% local embeddings
- LanceDB vector storage with SQLite metadata
- Stores specifications, completions, and workflow history with search

#### Workspace Manager (`src/workspaces/index.ts`)
- Git worktree-based isolation for parallel agent workspaces
- Automatic cleanup scheduling and resource management

#### Hook Handlers (`src/orchestration/hooks/index.ts`)
- **Dynamic CLI integration** - Works with any installation method
- Processes SubagentStop, PreToolUse, and SessionStart events
- Triggers autonomous workflows based on agent completion markers
- Auto-generated hook scripts with proper path resolution

### Database Schema
The SQLite database (`cns.db`) stores:
- `workflows` - Active agent workflows and specifications
- `handoffs` - Inter-agent communication and task delegation
- `memories` - Semantic memory with search capabilities
- `cleanup_schedule` - Automated workspace cleanup
- `tool_usage` - Tool usage tracking for analytics

### Agent Workflow Pattern
1. Manager agent receives task and creates specifications
2. CNS detects "Task Assignment" completion marker
3. CNS auto-launches associate agent with workspace isolation
4. Associate completes implementation and signals "Implementation Complete"
5. CNS auto-launches manager for review cycle
6. Manager approves with "Approved for Integration" or requests changes

### Hook Integration
**Auto-generated during setup** - hooks use dynamic path resolution:
```bash
#!/bin/bash
# Auto-generated by cns-server init
echo '{"transcript_path":"$1","agent_type":"$2","workflow_id":"$3","session_id":"$4"}' | cns-client handle_subagent_stop
```

Hook files created automatically:
- `~/.claude/hooks/subagent_stop.sh` - Workflow orchestration
- `~/.claude/hooks/pre_tool_use.sh` - Tool interception  
- `~/.claude/hooks/session_start.sh` - System status

### MCP Tools Available
- `handle_subagent_stop`, `handle_pre_tool_use`, `handle_session_start` - Hook handlers
- `store_memory`, `retrieve_memory` - Memory operations
- `launch_agent`, `get_pending_tasks`, `signal_completion` - Orchestration
- `create_workspace`, `cleanup_workspace` - Workspace management
- `get_system_status`, `get_workflow_status` - System monitoring

## Installation & Configuration

### Quick Start (Download-and-Go)
```bash
# 1. Install globally
npm install -g cns-mcp-server

# 2. Initialize configuration
cns-server init

# 3. Copy the generated Claude Code configuration (shown after init)
# 4. Hook scripts are created automatically in ~/.claude/hooks/
```

### Claude Code Settings  
**Auto-generated by `cns-server init`** - example output:
```json
{
  "mcpServers": {
    "cns": {
      "command": "npx",
      "args": ["-y", "cns-mcp-server"],
      "env": {
        "DATABASE_PATH": "/home/user/.cns/data/cns.db",
        "EMBEDDING_PROVIDER": "transformers",
        "EMBEDDING_MODEL": "Xenova/all-MiniLM-L6-v2"
      }
    }
  }
}
```

### Environment & Path Resolution
- **ES modules** with TypeScript compilation to ES2022
- **Dynamic path resolution** - supports all installation methods
- **Free embeddings** via Transformers.js (no API keys)
- **LanceDB + SQLite** for vector storage and metadata
- **Automatic setup** creates ~/.cns/ directory structure

### Environment Variables
- `CNS_SERVER_PATH` - Override server location
- `CNS_CLIENT_PATH` - Override client location  
- `DATABASE_PATH` - Custom database location
- `EMBEDDING_PROVIDER` - `transformers` (default) | `openai` | `none`

## üöÄ Production Deployment & CI/CD

### NPM Package Status
- **Published Package**: `cns-mcp-server` on NPM registry
- **Current Version**: Check `npm view cns-mcp-server version`
- **Installation**: `npm install -g cns-mcp-server`

### Automated CI/CD Pipeline
The repository includes comprehensive GitHub Actions workflows:

#### Test Pipeline (`.github/workflows/test.yml`)
- **Triggers**: Push to main, pull requests
- **Node Versions**: 18, 20, 22 (LTS support)
- **Tests**: Unit tests, integration tests, performance tests
- **Linting**: ESLint with TypeScript support
- **Race Condition Prevention**: LanceDB path isolation per test

#### Publish Pipeline (`.github/workflows/publish.yml`)
- **Triggers**: Git tags (v*.*.*)
- **Automated Steps**:
  1. Run full test suite
  2. Build production artifacts
  3. Sync package.json version with git tag
  4. Publish to NPM registry
  5. Create GitHub release

### Version Management
```bash
# Create new release
git tag v1.0.4
git push origin v1.0.4
# ‚Üí Automatically triggers NPM publish + GitHub release
```

### Performance & Testing Strategy
- **Functional Correctness**: Tests focus on what works, not timing
- **CI-Friendly**: No time-based assertions (unreliable in CI)
- **Concurrent Safety**: Race condition prevention for parallel tests
- **Memory Monitoring**: Resource usage tracking
- **Cross-Platform**: Tested on multiple Node.js versions

## üìÅ Repository Structure & Maintenance

### Clean Repository Philosophy
- **Source Only**: Only essential source code and documentation
- **No Build Artifacts**: `dist/` excluded from version control
- **No Runtime Data**: Database files, logs, caches excluded
- **Professional Appearance**: Clean, navigable public repository

### File Organization
```
‚îú‚îÄ‚îÄ src/                 # TypeScript source code
‚îú‚îÄ‚îÄ tests/               # Test suites
‚îú‚îÄ‚îÄ .github/workflows/   # CI/CD automation
‚îú‚îÄ‚îÄ docs/               # User documentation
‚îú‚îÄ‚îÄ package.json        # NPM configuration
‚îî‚îÄ‚îÄ README.md          # Project overview
```

### Excluded from Repository (.gitignore)
- Build artifacts (`dist/`, `*.tgz`)
- Runtime data (`*.db`, `*.log`, `data/`)
- Development cache (`node_modules/`, `.cache/`)
- IDE files (`.vscode/`, `.idea/`)
- Test databases (`test-*.db`)
- LanceDB data (`**/data/lancedb/`)

### Development Workflow
1. **Local Development**: Work in `src/`, test with `npm test`
2. **Git Tags**: Create version tags for releases
3. **Automated Publishing**: CI/CD handles NPM and GitHub releases
4. **Repository Hygiene**: `.gitignore` prevents unwanted files

## üß™ Testing Philosophy

### Test Categories
- **Unit Tests**: Individual component functionality
- **Integration Tests**: Multi-component workflows
- **Performance Tests**: System behavior under load
- **Workspace Tests**: Git worktree isolation

### CI/CD Test Strategy
- **Reliability over Speed**: Functional correctness vs timing assertions
- **Environment Agnostic**: Works across different CI environments
- **Parallel Safety**: Tests can run concurrently without conflicts
- **Resource Conscious**: Memory and performance monitoring